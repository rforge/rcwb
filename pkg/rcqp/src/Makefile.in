# ===========================================================================
# File: "Makefile.in"
#                        Created: 2012-01-14 11:45:26
#              Last modification: 2012-03-09 10:19:58
# Authors: Bernard Desgraupes <bernard.desgraupes@u-paris10.fr>
#          Sylvain Loiseau <sylvain.loiseau@univ-paris13.fr>
# This is part of the R package 'rcqp'.
# ===========================================================================
# NB: on Mac OSX 10.5, use -gdwarf-2 instead of -g to avoid warnings about
# missing "atom for N_GSYM stabs".
# 
# ARCHIS := -arch i386 -arch ppc -arch x86_64 -arch ppc64


## Read configuration settings for cwb
TOP = $(shell pwd)/../cwb
include $(TOP)/configRcqp.mk

ifeq ($(shell uname),Darwin)
RCQP_SHAREDLIB_FLAG=-dynamiclib
else
RCQP_SHAREDLIB_FLAG=-shared
endif

# Source files
# ------------

# C files
RCQP_C_SRC := rcqpCommands.c rcqpUtils.c

RCQP_C_OBJ := $(RCQP_C_SRC:.c=.o)

RCQP_VIGNETTE_RNW := rcqp.Rnw
RCQP_VIGNETTE_TEX :=  $(RCQP_VIGNETTE_RNW:.Rnw=.tex)
RCQP_VIGNETTE_IDX :=  $(RCQP_VIGNETTE_RNW:.Rnw=.idx)
RCQP_VIGNETTE_PDF :=  $(RCQP_VIGNETTE_RNW:.Rnw=.pdf)

RCQP_CWB_OBJ = ../cwb/cqp/ascii-print.o ../cwb/cqp/attlist.o ../cwb/cqp/builtins.o ../cwb/cqp/concordance.o \
../cwb/cqp/context_descriptor.o ../cwb/cqp/corpmanag.o ../cwb/cqp/cqp.o ../cwb/cqp/eval.o ../cwb/cqp/groups.o ../cwb/cqp/hash.o \
../cwb/cqp/html-print.o ../cwb/cqp/latex-print.o ../cwb/cqp/macro.o ../cwb/cqp/matchlist.o ../cwb/cqp/options.o ../cwb/cqp/output.o \
../cwb/cqp/parse_actions.o ../cwb/cqp/print-modes.o ../cwb/cqp/print_align.o ../cwb/cqp/ranges.o ../cwb/cqp/regex2dfa.o \
../cwb/cqp/sgml-print.o ../cwb/cqp/symtab.o ../cwb/cqp/table.o ../cwb/cqp/targets.o ../cwb/cqp/tree.o ../cwb/cqp/variables.o \
../cwb/CQi/server.o ../cwb/CQi/auth.o ../cwb/cqp/parser.tab.o ../cwb/cqp/parser.yy.o \
../cwb/cl/globals.o ../cwb/cl/macros.o \
   ../cwb/cl/list.o ../cwb/cl/lexhash.o \
   ../cwb/cl/bitfields.o ../cwb/cl/storage.o ../cwb/cl/fileutils.o \
   ../cwb/cl/special-chars.o ../cwb/cl/regopt.o \
   ../cwb/cl/corpus.o ../cwb/cl/attributes.o \
   ../cwb/cl/registry.tab.o ../cwb/cl/lex.creg.o \
   ../cwb/cl/makecomps.o \
   ../cwb/cl/cdaccess.o \
   ../cwb/cl/bitio.o \
   ../cwb/cl/endian.o \
   ../cwb/cl/compression.o \
   ../cwb/cl/binsert.o \
   ../cwb/cl/class-mapping.o

# Substitutable variables
# -----------------------

RCQP_STATLIB_CL=../cwb/cl/libcl.a
RCQP_STATLIB_CQP=../cwb/cqp/libcqp.a

RCQP_R_CPPFLAGS=`R CMD config --cppflags`


# TEMPORARY to build directly from Makefile in src/
ifndef LIBR
$(info LIBR defined using 'R CMD config --ldflags')
LIBR=`R CMD config --ldflags`
endif

# % pkg-config --libs libpcre
# -L/opt/local/lib -lpcre  
# % pkg-config --libs glib-2.0
# -L/opt/local/lib -lglib-2.0 -lintl  

ifndef LIBR
$(info LIBR defined using 'R CMD config --ldflags')
LIBR=`R CMD config --ldflags`
endif


# Targets
# -------

rcqp: ${RCQP_C_SRC} cwb
	# Compile the C files
	${CC} -c ${RCQP_C_SRC} ${RCQP_R_CPPFLAGS}
	#
	# Link the library
	${CC} -o $@.so $(RCQP_SHAREDLIB_FLAG) ${RCQP_C_OBJ} \
		${RCQP_CWB_OBJ} \
	    $(LDFLAGS_ALL) $(LDFLAGS_CQP) \
		${LIBR}

# # 	${CC} -o $@.so $(RCQP_SHAREDLIB_FLAG) ${RCQP_C_OBJ} \
# # 		${RCQP_STATLIB_CL} ${RCQP_STATLIB_CQP} \
# # 	    $(LDFLAGS_ALL) $(LDFLAGS_CQP) \
# # 		${LIBR}

cwb:
	$(MAKE) --makefile=MakefileRcqp -C ../cwb/cl
	$(MAKE) --makefile=MakefileRcqp -C ../cwb/cqp


.PHONY: clean


clean:
	$(MAKE) --makefile=MakefileRcqp -C ../cwb/cl clean
	$(MAKE) --makefile=MakefileRcqp -C ../cwb/cqp clean
	rm -f *.o *.so
	cd ../inst/doc/; \
	rm -f *.tex *.aux *.log *.toc *.idx *.synctex.gz


clean-all:
	$(MAKE) --makefile=MakefileRcqp -C ../cwb/cl realclean
	$(MAKE) --makefile=MakefileRcqp -C ../cwb/cqp clean-all
	rm -f *.o *.so
	cd ../inst/doc/; \
	rm -f *.tex *.aux *.log *.toc *.idx *.ind *.ilg *.pdf *.synctex.gz


vignette:
	cd ../inst/doc; \
	rm -f ${RCQP_VIGNETTE_TEX}; \
	echo "library(\"utils\"); Sweave(\"${RCQP_VIGNETTE_RNW}\")" | R --no-save --no-restore ; \
	pdflatex ${RCQP_VIGNETTE_TEX}; \
	makeindex ${RCQP_VIGNETTE_IDX}; \
	pdflatex ${RCQP_VIGNETTE_TEX};

